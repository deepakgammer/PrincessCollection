<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Manage Products | Princess Collection</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      display: flex;
      margin: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
    }
    .sidebar {
      width: 220px;
      background: #000;
      border-right: 2px solid #FFD700;
      padding: 20px;
      height: 100vh;
    }
    .sidebar h2 {
      color: #FFD700;
      margin-bottom: 20px;
      text-align: center;
    }
    .sidebar a {
      display: block;
      color: #FFD700;
      text-decoration: none;
      padding: 10px;
      margin: 8px 0;
      border-radius: 5px;
    }
    .sidebar a:hover {
      background: #FFD700;
      color: #000;
    }
    .main {
      flex: 1;
      padding: 20px;
    }
    h1 {
      color: #FFD700;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #222;
      color: #fff;
    }
    table th, table td {
      padding: 10px;
      border: 1px solid #444;
      text-align: left;
    }
    table th {
      background: #333;
    }
    button {
      padding: 6px 12px;
      margin: 2px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .btn-add {
      background: #FFD700;
      color: #000;
      font-weight: bold;
      margin-bottom: 15px;
    }
    .btn-edit {
      background: #007bff;
      color: #fff;
    }
    .btn-delete {
      background: #dc3545;
      color: #fff;
    }
    .form-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      padding: 20px;
      border: 2px solid #FFD700;
      border-radius: 10px;
      z-index: 1000;
      width: 400px;
    }
    .form-popup h2 {
      margin-bottom: 15px;
      color: #FFD700;
    }
    .form-popup input, 
    .form-popup textarea,
    .form-popup select {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      border: 1px solid #FFD700;
      border-radius: 5px;
      background: #000;
      color: #FFD700;
    }
    .form-popup button {
      margin-top: 10px;
      width: 100%;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Admin Panel</h2>
    <a href="admin-dashboard.html">Dashboard</a>
    <a href="admin-orders.html">Orders</a>
    <a href="admin-products.html" class="active">Products</a>
    <a href="admin-customers.html">Customers</a>
    <a href="admin-feedback.html">Feedback</a>
    <a href="login.html" id="logoutBtn">Logout</a>
  </div>

  <!-- Main Content -->
  <div class="main">
    <h1>Manage Products</h1>
    <button class="btn-add" onclick="openForm()">‚ûï Add Product</button>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Image</th>
          <th>Name</th>
          <th>Category</th>
          <th>Price</th>
          <th>Stock</th>
          <th>Weight (kg)</th>
          <th>Size</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="productsTable"></tbody>
    </table>
  </div>

  <!-- Product Form Popup -->
  <div class="form-popup" id="productForm">
    <h2 id="formTitle">Add Product</h2>
    <input type="hidden" id="productId">
    <input type="text" id="name" placeholder="Product Name" required>
    <textarea id="description" placeholder="Description"></textarea>
    <input type="number" id="price" placeholder="Price (‚Çπ)" required>
    <input type="number" id="stock" placeholder="Stock" required>
    <input type="number" id="weight" placeholder="Weight (kg)" required>
    <input type="text" id="size" placeholder="Size (e.g. 2 inch)">

    <!-- ‚úÖ Category dropdown -->
    <select id="category" required>
      <option value="">-- Select Category --</option>
      <option value="Bangles">Bangles</option>
      <option value="Earrings">Earrings</option>
      <option value="Clips">Clips</option>
      <option value="Bracelets">Bracelets</option>
      <option value="ChainSets">ChainSets</option>
    </select>

    <input type="text" id="image_url" placeholder="Image URL">
    <button onclick="saveProduct()">üíæ Save</button>
    <button onclick="closeForm()">‚ùå Cancel</button>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    const SUPABASE_URL = "https://tffqsmbmtotluhjagwds.supabase.co"
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmZnFzbWJtdG90bHVoamFnd2RzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3Njg5MTksImV4cCI6MjA3MzM0NDkxOX0.H8qY2F8XL8a7DKKhnQ_AAH1RxncbPHGnXdgd8LdQXnA"
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    const table = document.getElementById("productsTable")
    const formPopup = document.getElementById("productForm")
    const formTitle = document.getElementById("formTitle")
    const productIdEl = document.getElementById("productId")

    async function loadProducts() {
      let { data, error } = await supabase
        .from("products")
        .select("*")
        .order("id", { ascending: true })

      if (error) {
        console.error(error)
        return
      }

      table.innerHTML = data.map(p => `
        <tr>
          <td>${p.id}</td>
          <td><img src="${p.image_url}" alt="${p.name}" width="50"></td>
          <td>${p.name}</td>
          <td>${p.category || "-"}</td>
          <td>‚Çπ${p.price}</td>
          <td>${p.stock}</td>
          <td>${p.weight}</td>
          <td>${p.size || "-"}</td>
          <td>${p.is_active === false ? "‚ùå Inactive" : "‚úÖ Active"}</td>
          <td>
            <button class="btn-edit" 
              onclick="editProduct(${p.id}, '${p.name}', \`${p.description || ""}\`, ${p.price}, ${p.stock}, ${p.weight}, '${p.size || ""}', '${p.category || ""}', '${p.image_url || ""}')">
              Edit
            </button>
            <button class="btn-delete" onclick="deleteProduct(${p.id})">Delete</button>
          </td>
        </tr>
      `).join("")
    }

    // ‚ûï Open Form
    window.openForm = function() {
      formTitle.textContent = "Add Product"
      productIdEl.value = ""
      document.getElementById("name").value = ""
      document.getElementById("description").value = ""
      document.getElementById("price").value = ""
      document.getElementById("stock").value = ""
      document.getElementById("weight").value = ""
      document.getElementById("size").value = ""
      document.getElementById("category").value = ""
      document.getElementById("image_url").value = ""
      formPopup.style.display = "block"
    }
    window.closeForm = function() {
      formPopup.style.display = "none"
    }

    // ‚úèÔ∏è Edit Product
    window.editProduct = function(id, name, description, price, stock, weight, size, category, image_url) {
      formTitle.textContent = "Edit Product"
      productIdEl.value = id
      document.getElementById("name").value = name
      document.getElementById("description").value = description
      document.getElementById("price").value = price
      document.getElementById("stock").value = stock
      document.getElementById("weight").value = weight
      document.getElementById("size").value = size
      document.getElementById("category").value = category
      document.getElementById("image_url").value = image_url
      formPopup.style.display = "block"
    }

    // üíæ Save Product
    window.saveProduct = async function() {
      const id = productIdEl.value
      const name = document.getElementById("name").value
      const description = document.getElementById("description").value
      const price = parseFloat(document.getElementById("price").value)
      const stock = parseInt(document.getElementById("stock").value)
      const weight = parseFloat(document.getElementById("weight").value)
      const size = document.getElementById("size").value
      const category = document.getElementById("category").value
      const image_url = document.getElementById("image_url").value

      if (!name || !price || !stock || !weight || !category) {
        alert("‚ö†Ô∏è Please fill required fields (including Category)")
        return
      }

      if (id) {
        await supabase.from("products").update({ 
          name, description, price, stock, weight, size, category, image_url 
        }).eq("id", id)
        alert("‚úÖ Product updated!")
      } else {
        await supabase.from("products").insert([{ 
          name, description, price, stock, weight, size, category, image_url, is_active: true 
        }])
        alert("‚úÖ Product added!")
      }

      closeForm()
      loadProducts()
    }

    // ‚ùå Safe Delete (Soft Delete)
    window.deleteProduct = async function(id) {
      if (!confirm("‚ö†Ô∏è Are you sure you want to delete this product?")) return

      let { data: cartRefs, error: cartError } = await supabase
        .from("cart_items")
        .select("id")
        .eq("product_id", id)

      if (cartError) {
        console.error(cartError)
        alert("‚ùå Error checking cart references.")
        return
      }

      if (cartRefs.length > 0) {
        await supabase.from("products").update({ is_active: false }).eq("id", id)
        alert("‚ö†Ô∏è Product marked inactive (customers already have it in carts).")
      } else {
        await supabase.from("products").delete().eq("id", id)
        alert("‚úÖ Product deleted successfully!")
      }

      loadProducts()
    }

    // Initial Load
    loadProducts()
  </script>
</body>
</html>
