<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout</title>
  <link rel="stylesheet" href="style.css">
  <style>
    #checkout-form button:disabled {
      background: gray;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .qr-section {
      margin-top: 20px;
      text-align: center;
    }
    .qr-section img {
      max-width: 250px;
    }
    .upload-proof {
      margin-top: 20px;
    }
    #proceedBtn {
      background: #ffd700;
      color: black;
      font-weight: bold;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 15px;
    }
  </style>
</head>
<body>

  <header>
    <div class="logo">
      <img src="assets/logo.png" alt="Princess Collection Logo">
    </div>
    <nav>
      <a href="index.html">Home</a>
      <a href="shop.html">Shop</a>
      <a href="#">About</a>
      <a href="#">Contact</a>
      <a href="cart.html">Cart üõí</a>
      <button id="logoutBtn" style="display:none">Logout</button>
    </nav>
  </header>

  <main>
    <h2>Checkout</h2>

    <div id="cart-summary"></div>

    <form id="checkout-form">
      <input type="text" id="name" placeholder="Full Name" required><br>
      <input type="text" id="phone" placeholder="Phone Number" required><br>
      <input type="text" id="whatsapp" placeholder="WhatsApp Number" required><br>
      <input type="email" id="email" placeholder="Email" required><br>
      <textarea id="address" placeholder="Shipping Address" required></textarea><br>

      <button type="button" id="proceedBtn">Proceed to Payment</button>

      <div class="qr-section" id="qr-section" style="display:none">
        <h3>üì≤ Scan & Pay</h3>
        <img id="qr-code" src="" alt="QR Code">
        <p id="qr-amount"></p>
      </div>

      <div class="upload-proof" id="proof-section" style="display:none">
        <label>Upload Payment Proof Screenshot:</label><br>
        <input type="file" id="paymentProof" accept="image/*" required><br><br>
        <button type="submit" id="submitOrder">Submit Order</button>
      </div>
    </form>

    <p id="message"></p>
  </main>

  <footer>
    <p>¬© 2025 Princess Collection. All Rights Reserved.</p>
  </footer>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const SUPABASE_URL = "https://tffqsmbmtotluhjagwds.supabase.co"
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmZnFzbWJtdG90bHVoamFnd2RzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3Njg5MTksImV4cCI6MjA3MzM0NDkxOX0.H8qY2F8XL8a7DKKhnQ_AAH1RxncbPHGnXdgd8LdQXnA"
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    const form = document.getElementById("checkout-form")
    const message = document.getElementById("message")
    const cartSummary = document.getElementById("cart-summary")
    const qrSection = document.getElementById("qr-section")
    const qrImg = document.getElementById("qr-code")
    const qrAmount = document.getElementById("qr-amount")
    const proofSection = document.getElementById("proof-section")
    const proofInput = document.getElementById("paymentProof")
    const proceedBtn = document.getElementById("proceedBtn")

    let finalTotal = 0
    let shipping = 0

    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
      message.textContent = "‚ö†Ô∏è Please log in to checkout."
      throw new Error("No user logged in")
    }

    async function loadCartFromSupabase() {
      let { data, error } = await supabase
        .from("cart_items")
        .select("*, products(*)")
        .eq("user_id", user.id)

      if (error) return []
      return data.map(item => ({
        id: item.product_id,
        name: item.products?.name,
        price: item.products?.price,
        image_url: item.products?.image_url,
        quantity: item.quantity
      }))
    }

    async function renderCartSummary() {
      const cart = await loadCartFromSupabase()
      if (cart.length === 0) {
        cartSummary.innerHTML = "<p>üõí Your cart is empty!</p>"
        proceedBtn.disabled = true
        return []
      }

      let total = 0
      cartSummary.innerHTML = `
        <h3>Order Summary</h3>
        <div class="order-summary">
          ${cart.map(item => {
            total += item.price * item.quantity
            return `
              <div class="summary-item">
                <img src="${item.image_url}" alt="${item.name}">
                <p>${item.name} (x${item.quantity}) - ‚Çπ${item.price * item.quantity}</p>
              </div>
            `
          }).join("")}
      `

      if (total < 500) {
        shipping = 90
        message.textContent = `üöö Shipping ‚Çπ90 applied (Orders below ‚Çπ500)`
      } else {
        shipping = 0
        message.textContent = `üöö Free Shipping`
      }

      finalTotal = total + shipping

      cartSummary.innerHTML += `
          <p><strong>Subtotal: ‚Çπ${total}</strong></p>
          <p><strong>Shipping: ‚Çπ${shipping}</strong></p>
          <p class="grand-total"><strong>Final Total: ‚Çπ${finalTotal}</strong></p>
        </div>
      `

      return { cart, finalTotal }
    }

    let { cart } = await renderCartSummary()

    proceedBtn.addEventListener("click", () => {
      qrSection.style.display = "block"
      proofSection.style.display = "block"
      proceedBtn.style.display = "none"

      const upiId = "9094900636@yescred"
      const payUrl = `upi://pay?pa=${upiId}&pn=PrincessCollection&am=${finalTotal}&cu=INR`

      qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(payUrl)}`
      qrAmount.innerHTML = `Scan & Pay: <strong>‚Çπ${finalTotal}</strong>`
    })

    form.addEventListener("submit", async (e) => {
      e.preventDefault()

      const file = proofInput.files[0]
      if (!file) return message.textContent = "‚ö†Ô∏è Please upload payment proof!"

      const filePath = `proofs/${user.id}_${Date.now()}_${file.name}`
      let { error: uploadError } = await supabase.storage.from("payment_proofs").upload(filePath, file)
      if (uploadError) return message.textContent = "‚ùå Failed to upload proof."

      const { data: { publicUrl } } =
        supabase.storage.from("payment_proofs").getPublicUrl(filePath)

      const name = document.getElementById("name").value
      const phone = document.getElementById("phone").value
      const whatsapp = document.getElementById("whatsapp").value
      const email = document.getElementById("email").value
      const address = document.getElementById("address").value

      let { error } = await supabase.from("orders").insert([{
        user_id: user.id,
        customer_name: name,
        customer_phone: phone,
        customer_whatsapp: whatsapp,
        customer_email: email,
        customer_address: address,
        items: cart,
        total: finalTotal,
        shipping_charge: shipping,
        status: "pending_verification",
        payment_proof_url: publicUrl,
        created_at: new Date().toISOString()
      }])

      if (error) return message.textContent = "‚ö†Ô∏è Order save failed!"

      await supabase.from("cart_items").delete().eq("user_id", user.id)

      form.reset()
      qrSection.style.display = "none"
      proofSection.style.display = "none"

      message.innerHTML = `‚úÖ Order Submitted!<br>We will verify your payment shortly.`
    })
  </script>

</body>
</html>
